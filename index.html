<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fridge Tracker</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      max-width: 500px;
      margin: 2rem auto;
      background: #f4f7fa;
      color: #333;
      text-align: center;
    }
    button {
      margin: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: #007bff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    input {
      width: 80%;
      padding: 8px;
      margin: 5px 0;
      font-size: 16px;
    }
    .page { display: none; }
    .active { display: block; }
  </style>
</head>
<body>

  <div id="home" class="page active">
    <h1>Fridge App</h1>
    <button onclick="gotoPage('putin')">PUT IN</button>
    <button onclick="gotoPage('takeout')">TAKE OUT</button>
  </div>

  <div id="putin" class="page">
    <h2>Put In Items</h2>
    <div id="putinItems"></div>
    <div id="putinForm" style="display:none;">
      <h3 id="putinSelected"></h3>
      <input type="date" id="putinDate" min=""><br>
      <input type="number" id="putinQty" placeholder="Quantity"><br>
      <button onclick="submitToGoogleSheet('PUT IN')">OK</button>
      <button onclick="cancelForm()">Cancel</button>
    </div>
    <button onclick="gotoPage('home')">Back</button>
  </div>

  <div id="takeout" class="page">
    <h2>Take Out Items</h2>
    <div id="takeoutItems"></div>
    <div id="takeoutForm" style="display:none;">
      <h3 id="takeoutSelected"></h3>
      <input type="datetime-local" id="takeoutTime"><br>
      <input type="number" id="takeoutQty" placeholder="Quantity"><br>
      <button onclick="submitToGoogleSheet('TAKE OUT')">OK</button>
      <button onclick="cancelForm()">Cancel</button>
    </div>
    <button onclick="gotoPage('home')">Back</button>
  </div>

<script>
  const items = ["Milk", "Cheese", "Eggs", "Yogurt"];
  const scriptURL = "https://script.google.com/macros/s/AKfycbygp-8wTN-d_3bjwH4enaDreTQX_BmDfllc5nQnnq1Y1W2QslKNwHdTINhIhFcV_fp4/exec";

  let currentItem = "";

  function gotoPage(page) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById(page).classList.add("active");

    if (page === "putin") {
      loadItemButtons("putin");
      const putinDate = document.getElementById("putinDate");
      const today = new Date().toISOString().split("T")[0];
      putinDate.min = today;
    }
    if (page === "takeout") loadItemButtons("takeout");

    cancelForm();
  }

  function loadItemButtons(action) {
    const container = document.getElementById(action + "Items");
    container.innerHTML = "";
    items.forEach(item => {
      const btn = document.createElement("button");
      btn.textContent = item;
      btn.onclick = () => showForm(action, item);
      container.appendChild(btn);
    });
  }

  function showForm(action, item) {
    currentItem = item;
    document.getElementById(action + "Selected").textContent = `${action.toUpperCase().replace(/^\w/, c => c.toUpperCase())}: ${item}`;
    document.getElementById(action + "Form").style.display = "block";
  }

  function cancelForm() {
    document.querySelectorAll("#putinForm, #takeoutForm").forEach(f => f.style.display = "none");
    document.querySelectorAll("input").forEach(i => i.value = "");
  }

  async function submitToGoogleSheet(actionType) {
    const idPrefix = actionType === "PUT IN" ? "putin" : "takeout";

    let expiry = "";
    if (actionType === "PUT IN") {
      expiry = document.getElementById("putinDate").value;  // 日期 yyyy-mm-dd
    } else {
      expiry = document.getElementById(idPrefix + "Time").value.substring(0, 10);
    }

    const qty = document.getElementById(idPrefix + "Qty").value;

    if (!expiry || !qty) {
      alert("請填入日期與數量！");
      return;
    }

    const payload = {
      action: actionType,
      item: currentItem,
      quantity: qty,
      expiry: expiry
    };

    const formBody = Object.entries(payload)
      .map(([k, v]) => encodeURIComponent(k) + "=" + encodeURIComponent(v))
      .join("&");

    try {
      const res = await fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formBody,
      });

      const result = await res.json();

      if (result.status === "success") {
        alert("資料已寫入 Google Sheet！");
        cancelForm();
        gotoPage("home");
      } else {
        alert("寫入失敗：" + result.message);
      }
    } catch (err) {
      alert("錯誤：" + err.message);
    }
  }
</script>

</body>
</html>
